import org.gradle.api.artifacts.ResolveException

apply plugin: "com.liferay.target.platform"

dependencies {
	targetPlatformBoms group: "com.liferay", name: "com.liferay.ce.portal.bom", version: "7.0.4"
}

targetPlatform {
	onlyIf { it.name != 'sub1' }
}

task runGradleTest

runGradleTest {
	doLast {
		assert project.configurations.targetPlatformBoms.size() == 1
		assert project.configurations.targetPlatformBoms[0].name.equals("com.liferay.ce.portal.bom-7.0.4.pom")

		def sub1 = project.childProjects["sub1"]

		def expectedFailure

		try {
			sub1.configurations.compile.resolvedConfiguration.resolvedArtifacts
		}
		catch (ResolveException e) {
			expectedFailure = e.cause
		}

		assert expectedFailure.message.contains("Could not find com.liferay.portal:com.liferay.portal.kernel:")

		def sub2 = project.childProjects["sub2"]

		assert sub2.dependencyManagement.managedVersions.size() == 898

		try {
			sub2.configurations.compile.resolvedConfiguration.resolvedArtifacts
		}
		catch (ResolveException e) {
			expectedFailure = e.cause
		}

		assert expectedFailure.message.contains("com.liferay.portal:com.liferay.portal.kernel:2.61.1")
	}
}